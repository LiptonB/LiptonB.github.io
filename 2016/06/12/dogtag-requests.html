<!DOCTYPE html>
<html lang="en">

<head>
      <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="canonical" href="http://blog.benjaminlipton.com/2016/06/12/dogtag-requests.html" />

    <title>  bl stash save &mdash; Manually requesting certs from Dogtag with certmonger debug tools
</title>




    <link rel="stylesheet" href="http://blog.benjaminlipton.com/theme/css/style.css">

    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->


    <meta name="author" content="Benjamin Lipton">
    <meta name="description" content="This post records the results some experimentation with the Dogtag API. Specifically, we will show how to authenticate against the API using credentials that are automatically generated by FreeIPA installation, how to use debug tools distributed with certmonger to issue certificates via the API, and a method of tweaking the ...">
  <meta name="tags" contents="">
</head>

<body>
<header class="header">
  <div class="container">
    <div class="header-inner">
      <h1 class="header-name">
        <a class="nodec" href="http://blog.benjaminlipton.com">bl stash save</a>
      </h1>
      <h3 class="header-text"></h3>
      <ul class="header-menu list-inline">
      </ul>
    </div>
  </div>
</header> <!-- /.header -->  <div class="container">
  <div class="post full-post">
    <h1 class="post-title">
      <a href="/2016/06/12/dogtag-requests.html" title="Permalink to Manually requesting certs from Dogtag with certmonger debug tools">Manually requesting certs from Dogtag with certmonger debug tools</a>
    </h1>
    <ul class="list-inline">
      <li class="post-date">
        <a class="text-muted" href="/2016/06/12/dogtag-requests.html" title="2016-06-12T00:00:00-04:00">Sun 12 June 2016</a>
      </li>
      <li class="muted">&middot;</li>
      <li class="post-category">
        <a href="http://blog.benjaminlipton.com/category/freeipa.html">freeipa</a>
      </li>
    </ul>
    <div class="post-content">
      <p>This post records the results some experimentation with the Dogtag API. Specifically, we will show how to authenticate against the API using credentials that are automatically generated by FreeIPA installation, how to use debug tools distributed with certmonger to issue certificates via the API, and a method of tweaking the created cert via the API parameters passed.</p>
<h2 id="acquiring-the-tool">Acquiring the tool</h2>
<p>We will be using the <code>submit-d</code> tool, included in the certmonger source distribution but not the binary packages. First we download the source and build it:</p>
<div class="highlight"><pre><span></span>$ git clone git://git.fedorahosted.org/git/certmonger.git
$ <span class="nb">cd</span> certmonger
$ sudo dnf install dbus-devel gettext-devel libidn-devel
$ ./autogen.sh
$ make
</pre></div>


<h2 id="authentication-setup">Authentication setup</h2>
<p>FreeIPA uses a client certificate stored in the NSS database <code>/etc/httpd/alias</code> to authenticate to Dogtag. Unfortunately, this database uses the older DBM format, while the tool we will be using requires the newer SQLite format. So first we must create a new database and copy the cert we need into it, via a PKCS12 file:</p>
<div class="highlight"><pre><span></span>mkdir /tmp/certs
certutil -N -d sql:/tmp/certs
sudo pk12util -o ipaCert.p12 -n ipaCert -d /etc/httpd/alias -k /etc/httpd/alias/pwdfile.txt
sudo pk12util -i ipaCert.p12 -n ipaCert -d sql:/tmp/certs
</pre></div>


<p>At all password prompts, hit enter. We now have two certs in the file - <code>ipaCert</code>, the client cert we will use for authentication, and the CA cert that signs all of the certs issued by FreeIPA:</p>
<div class="highlight"><pre><span></span>[admin@vm-166 certs]$ certutil -L -d sql:/tmp/certs

Certificate Nickname                                         Trust Attributes
                                                             SSL,S/MIME,JAR/XPI

ipaCert                                                      u,u,u
DOMAIN.EXAMPLE.COM IPA CA                                    ,,
</pre></div>


<p>Mark the CA cert as trusted, otherwise the client will refuse to talk to the server:</p>
<div class="highlight"><pre><span></span>certutil -M -t TC,, -d sql:/tmp/certs -n <span class="s1">&#39;DOMAIN.EXAMPLE.COM IPA CA&#39;</span>
</pre></div>


<h2 id="making-requests">Making requests</h2>
<p>Generate a keypair and a CSR to submit to the CA. The <code>openssl req</code> command will prompt for the certificate subject; fill it out however you like.</p>
<div class="highlight"><pre><span></span>$ openssl genrsa -out test.key
$ openssl req -new -key /tmp/certs/test.key -out /tmp/certs/test.req
</pre></div>


<p>Use the <code>submit-d</code> tool to submit the request to Dogtag. If we use the <code>caIPAserviceCert</code> template, the request goes through immediately and we are presented with a certificate:</p>
<div class="highlight"><pre><span></span>$ src/submit-d -u https://server.example.com:8443/ca/ee/ca -U https://server.example.com:8443/ca/agent/ca <span class="se">\</span>
    -vv -d /tmp/certs -C ipaCert -a -T caIPAserviceCert -s /tmp/certs/test.req
</pre></div>


<p>We can see from the output that the tool makes a POST request to the <code>profileSubmit</code> endpoint of the server.</p>
<p>On the other hand, if we use a non-IPA cert such as <code>caServerCert</code>, the tool makes the same call but the request will be deferred until approved:</p>
<div class="highlight"><pre><span></span>$ src/submit-d -u https://server.example.com:8443/ca/ee/ca -U https://server.example.com:8443/ca/agent/ca <span class="se">\</span>
    -vv -d /tmp/certs -C ipaCert -a -T caServerCert -s /tmp/certs/test.req
</pre></div>


<p>In this case, a <code>requestId</code> is provided; we will use this to approve the request:</p>
<div class="highlight"><pre><span></span>result = &quot;&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; standalone=&quot;no&quot;?&gt;&lt;XMLResponse&gt;&lt;Status&gt;2&lt;/Status&gt;&lt;Error&gt;Request Deferred - {0}&lt;/Error&gt;&lt;RequestId&gt;  31&lt;/RequestId&gt;&lt;/XMLResponse&gt;&quot;
error: Request Deferred - {0}
status: 2
requestId: 31
</pre></div>


<p>We can approve the request with the <code>-A</code> flag and receive the certificate:</p>
<div class="highlight"><pre><span></span>$ src/submit-d -u https://server.example.com:8443/ca/ee/ca -U https://server.example.com:8443/ca/agent/ca <span class="se">\</span>
    -vv -d /tmp/certs -C ipaCert -a -T caServerCert -A 31
</pre></div>


<h2 id="tweaking-certificate-parameters">Tweaking certificate parameters</h2>
<p>If we look through the output of the approval command run above, we see a call to the <code>profileProcess</code> endpoint on the Dogtag server. Interestingly, this call includes many of the parameters of the certificate:</p>
<div class="highlight"><pre><span></span>GET /ca/agent/ca/profileProcess?requestId=31&amp;op=approve&amp;xml=true&amp;name=CN%3Dserver.example.com%2CO%3DDOMAIN.EXAMPLE.COM&amp;notBefore=2016-06-13+02%3A50%3A46&amp;notAfter=2018-06-03+02%3A50%3A46&amp;authInfoAccessCritical=false&amp;authInfoAccessGeneralNames=Record+%230%0AMethod%3A1.3.6.1.5.5.7.48.1%0ALocation+Type%3AURIName%0ALocation%3Ahttp%3A%2F%2Fserver.example.com%3A80%2Fca%2Focsp%0AEnable%3Atrue&amp;keyUsageCritical=true&amp;keyUsageDigitalSignature=true&amp;keyUsageNonRepudiation=true&amp;keyUsageKeyEncipherment=true&amp;keyUsageDataEncipherment=true&amp;keyUsageKeyAgreement=false&amp;keyUsageKeyCertSign=false&amp;keyUsageCrlSign=false&amp;keyUsageEncipherOnly=false&amp;keyUsageDecipherOnly=false&amp;exKeyUsageCritical=false&amp;exKeyUsageOIDs=1.3.6.1.5.5.7.3.1%2C1.3.6.1.5.5.7.3.2&amp;signingAlg=SHA256withRSA HTTP/1.1
</pre></div>


<p>The tool gets these parameters by parsing the output of a call to the <code>profileReview</code> endpoint. However, we will just re-use the same values, making a small modification to the <code>name</code> parameter.
What happens if we submit the request again, and then approve it with the modified parameters?</p>
<div class="highlight"><pre><span></span>src/submit-d -u https://server.example.com:8443/ca/ee/ca -U https://server.example.com:8443/ca/agent/ca <span class="se">\</span>
    -vv -d /tmp/certs -C ipaCert -a -T caServerCert -A <span class="m">32</span> <span class="se">\</span>
    -V <span class="s1">&#39;name=CN%3Dnewname%2CO%3DEXAMPLE.COM&amp;notBefore=2016-06-13+02%3A50%3A46&amp;notAfter=2018-06-03+02%3A50%3A46&amp;authInfoAccessCritical=false&amp;authInfoAccessGeneralNames=Record+%230%0AMethod%3A1.3.6.1.5.5.7.48.1%0ALocation+Type%3AURIName%0ALocation%3Ahttp%3A%2F%2Fserver.example.com%3A80%2Fca%2Focsp%0AEnable%3Atrue&amp;keyUsageCritical=true&amp;keyUsageDigitalSignature=true&amp;keyUsageNonRepudiation=true&amp;keyUsageKeyEncipherment=true&amp;keyUsageDataEncipherment=true&amp;keyUsageKeyAgreement=false&amp;keyUsageKeyCertSign=false&amp;keyUsageCrlSign=false&amp;keyUsageEncipherOnly=false&amp;keyUsageDecipherOnly=false&amp;exKeyUsageCritical=false&amp;exKeyUsageOIDs=1.3.6.1.5.5.7.3.1%2C1.3.6.1.5.5.7.3.2&amp;signingAlg=SHA256withRSA&#39;</span>
</pre></div>


<p>Our new name shows up in the certificate!</p>
<div class="highlight"><pre><span></span>Certificate:
    Data:
        Version:  v3
        Serial Number: 0x1E
        Signature Algorithm: SHA256withRSA - 1.2.840.113549.1.1.11
        Issuer: CN=Certificate Authority,O=DOMAIN.EXAMPLE.COM
        Validity:
            Not Before: Monday, June 13, 2016 2:50:46 AM GMT
            Not  After: Sunday, June 3, 2018 2:50:46 AM GMT
        Subject: CN=newname,O=EXAMPLE.COM
</pre></div>
    </div>
  </div>
  <hr class="separator">
  <div class="col-md-8 col-md-offset-2">
  </div>
  </div>
<footer class="footer">
  <div class="container">
    <p class="text-center">
      Benjamin Lipton, <a href="" target="_blank"></a> unless otherwise noted.
    </p>
    <div class="text-center">
      Generated by <a href="http://getpelican.com" target="_blank">Pelican</a> with the <a href="http://github.com/nairobilug/pelican-alchemy">alchemy</a> theme.
    </div>
  </div>
</footer> <!-- /.footer -->
  <script src="http://blog.benjaminlipton.com/theme/js/jquery.min.js"></script>
  <script src="http://blog.benjaminlipton.com/theme/js/bootstrap.min.js"></script>
</body> <!-- 42 -->

</html>